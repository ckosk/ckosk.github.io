<?xml version="1.0" encoding="UTF-8"?>
<Module>
    <ModulePrefs title="Photobooth" description="Photobooth Functionality" author="" background="transparent">
        <Require feature="reveldigital" />
        <UserPref name="myCountdownPref" display_name="Timer Duration" datatype="string" default_value="5" required="true" />
        <UserPref name="myQRSizePref" display_name="QR Code Size (pixels)" datatype="string" default_value="300" required="true" />
        <UserPref name="timerLoc" display_name="Timer Location" datatype="enum" default_value="TLeft" required="true">
            <EnumValue value="TLeft" display_value="Top-Left" />
            <EnumValue value="TRight" display_value="Top-Right" />
            <EnumValue value="BLeft" display_value="Bottom-Left" />
            <EnumValue value="BRight" display_value="Bottom-Right" />
        </UserPref>
        <UserPref name="textStyle" display_name="Countdown Style" datatype="style" default_value="font-family:Verdana;color:rgb(255, 255, 255);font-size:64px;font-weight:bold;" required="true" />
        <UserPref name="ForeColor" datatype="hidden" />
        <UserPref name="BackColor" datatype="hidden" />
        <UserPref name="rdW" display_name="Width" required="true" default_value="280" datatype="hidden" />
        <UserPref name="rdH" display_name="Height" required="true" default_value="190" datatype="hidden" />
        <UserPref name="regkey" display_name="Device Registration Key" default_value="*|DEVICE.REGISTRATIONKEY|*" datatype="hidden" />
    </ModulePrefs>
    <Content type="html"><![CDATA[<style type="text/css">

    body *{
        line-height: 1.2em; 
        letter-spacing: 0; 
        word-spacing: normal;
    }

    body{
        background-color: black;
        padding: 0;
        margin: 0;
    }

    .flash{ 
        position:fixed; 
        top:0;
        left:0;
        width:100%;
        height:100%;
        background-color:#fff;
    }

    .my-style{
        __UP_myStylePref__;
    }

    #countdown{
        position: absolute;
        __UP_textStyle__;
    }

    #qrCode{
        position: relative;
        z-index: 999;
    }

    #qrCode img{
        width: __UP_myQRSizePref__px;
        height: __UP_myQRSizePref__px;
    }

    #canvas{
        position: absolute;
        overflow: auto;
        margin: auto;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }

    #video{
        display: block;
    }

    video{
        object-fit: fill;
    }

    .vid{
        position: absolute; 
        top: 0; left:0;
        width: 100%; height: 100%; 
        z-index: -1;
        margin: 0px;
    }

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>

<body>
    <div class="flash"></div>
    <div id="countdown"></div>
    <div id="qrCode"></div>
    <div class='vid'><video id="video" width="1080" height="1920" muted autoplay></video></div>
    <canvas id="canvas" width="1080" height="1920"></canvas>
</body>

<script type="text/javascript">

    var prefs = new gadgets.Prefs();

    let timerStyle = "__UP_timerLoc__";
    let qrSize = "__UP_myQRSizePref__";
    var functionIsRunning = false;
    let justTaken = true;

    const context = canvas.getContext('2d');
    const video = document.getElementById("video")
    var videoAtt = document.getElementsByTagName("video")[0];
    document.getElementById('countdown').hidden = true;
    key = prefs.getString("regkey");
    $('.flash').hide();

    //QR code format: "https://photo-booth.herokuapp.com/?key=RegKey" Ex: https://photo-booth.herokuapp.com/?key=7ef4a535-e988-4f71-ada8-522a5b5da812
    document.getElementById("qrCode").innerHTML = ("<img src='https://api.qrserver.com/v1/create-qr-code/?size= + qrSize + x + qrSize + &data=https://photo-booth.herokuapp.com/?key=" + key + "'>");

    if (timerStyle == "TRight"){
        document.getElementById("countdown").style.right = "0";
        document.getElementById("countdown").style.top = "0";
        document.getElementById("qrCode").style.right = "0";
        document.getElementById("qrCode").style.top = "0";}
    else if (timerStyle == "BLeft"){
        document.getElementById("countdown").style.left = "0";
        document.getElementById("countdown").style.bottom = "0";
        document.getElementById("qrCode").style.left = "0";
        document.getElementById("qrCode").style.bottom = "0";}
    else if (timerStyle == "BRight"){
        document.getElementById("countdown").style.right = "0";
        document.getElementById("countdown").style.bottom = "0";
        document.getElementById("qrCode").style.right = "0";
        document.getElementById("qrCode").style.bottom = "0";}
    else if (timerStyle == "TLeft"){
        document.getElementById("countdown").style.left = "0";
        document.getElementById("countdown").style.top = "0";
        document.getElementById("qrCode").style.left = "0";
        document.getElementById("qrCode").style.top = "0";}

    function flash(){
        $('.flash')
        .show()
        .animate({opacity: 0.5}, 650) 
        .fadeOut(900)
        .css({'opacity': 1});
    }

    var canvases = document.getElementsByTagName("canvas");
    function animCanv(){
        for(var c in canvases) {
            $(canvases[c]).animate({
                'width': "945px",
                'height': "1680px"
            }, 1000);
        }
    }
    
    window.RevelDigital = {
        Controller: {
            onCommand: function(name, arg) {
                if (arg == "start") {
                    document.getElementById('qrCode').hidden = true;
                    document.getElementById("canvas").style.border = "none";
                    startTimer();
                }
                else if (arg != "timeout") {
                    videoAtt.height = 1920;
                    videoAtt.width = 1080;
                    canvas.getContext('2d').drawImage(video, 0, 0, 1080, 1920);
                    var data = canvas.toDataURL();
                    flash();
                    axios.post("https://photo-booth.herokuapp.com/photo", {
                        "key": key,
                        "background": data.substring(data.indexOf(',') + 1),
                        "overlay": arg
                    })
                    .then((response) => console.log(response.data))
                    .then((error) => console.log(error));
                    videoAtt.height = 1;
                    videoAtt.width = 1;
                    document.getElementsByTagName("canvas").hidden = false;
                    document.getElementById("canvas").style.border = "5px solid white";
                    animCanv();
                    justTaken = true;
                }
            },
            onStart: function() {},
            onStop: function() {}
        }
    }

    async function getMedia() {
        let stream = null;
        try {
            stream = await navigator.mediaDevices.getUserMedia({video: true})
            video.srcObject = stream;
        } catch (err) {
            console.log("error displaying stream");
        }
    }
    getMedia();

    function startTimer() {
        let timeRemain = __UP_myCountdownPref__;
        justTaken = false;
        if (!functionIsRunning) {
            videoAtt.height = 1920;
            videoAtt.width = 1080;
            context.clearRect(0, 0, canvas.width, canvas.height);
            functionIsRunning = true;
            var countdownTimer = setInterval(function() {
                if (timeRemain <= 0) {
                    clearInterval(countdownTimer);
                    document.getElementById('countdown').hidden = true;
                    Client.sendCommand("takesnapshot", "");
                    functionIsRunning = false;
                } else {
                    document.getElementById("countdown").innerHTML = timeRemain;
                    document.getElementById('countdown').hidden = false;
                }
                timeRemain -= 1;
            }, 1000);
        }
    }

    /*
    const checkIdle = async () => {
        if (justTaken){
            await delay(30000);
            document.getElementById("canvas").style.border = "none";
            context.clearRect(0, 0, canvas.width, canvas.height);
            videoAtt.height = 1920;
            videoAtt.width = 1080;
            document.getElementById('qrCode').hidden = false;
            Client.sendCommand("photobooth", "timeout");
        }
    };*/

    function tempTimeout(){
        if (justTaken){
            document.getElementById("canvas").style.border = "none";
            context.clearRect(0, 0, canvas.width, canvas.height);
            videoAtt.height = 1920;
            videoAtt.width = 1080;
            document.getElementById('qrCode').hidden = false;
            Client.sendCommand("photobooth", "timeout");
        }
    }

    var sleepTimer = setInterval(function() {
        tempTimeout();
    }, 30000); 

</script>]]></Content>
</Module>