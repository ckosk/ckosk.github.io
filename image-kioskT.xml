<?xml version="1.0" encoding="UTF-8"?>
<Module>
   <ModulePrefs title="Photobooth Kiosk" description="Testing Photobooth Kiosk" author="" background="transparent">
      <Require feature="reveldigital" />
      <UserPref name="myCountdownPref" display_name="Timer Duration" datatype="string" default_value="5" required="true" />
      <UserPref name="timerLoc" display_name="Timer Location" datatype="enum" default_value="TLeft" required="true">
         <EnumValue value="TLeft" display_value="Top-Left" />
         <EnumValue value="TRight" display_value="Top-Right" />
         <EnumValue value="BLeft" display_value="Bottom-Left" />
         <EnumValue value="BRight" display_value="Bottom-Right" />
      </UserPref>
      <UserPref name="textStyle" display_name="Countdown Style" datatype="style" default_value="font-family:Verdana;color:rgb(255, 255, 255);font-size:64px;font-weight:bold;" required="true" />
      <UserPref name="ForeColor" datatype="hidden" />
      <UserPref name="BackColor" datatype="hidden" />
      <UserPref name="rdW" display_name="Width" required="true" default_value="280" datatype="hidden" />
      <UserPref name="rdH" display_name="Height" required="true" default_value="190" datatype="hidden" />
      <UserPref name="rdKey" display_name="Device Registration Key" default_value="*|DEVICE.REGISTRATIONKEY|*" datatype="hidden" />
   </ModulePrefs>
   <Content type="html"><![CDATA[<style type="text/css">

    body *{
        line-height: 1.2em; 
        letter-spacing: 0; 
        word-spacing: normal;
    }

    body{
        background-color: transparent;
    }

    .my-style{
        __UP_myStylePref__;
    }

    #countdown{
        position: absolute;
        __UP_textStyle__;
    }

    #qrCode{
        position: absolute;
    }

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>

<body>
    <div id="countdown"></div>
    <div id="qrCode"></div>
</body>

<script type="text/javascript">

    var prefs = new gadgets.Prefs();

    let timeRemain = __UP_myCountdownPref__;
    let timerStyle = "__UP_timerLoc__";

    //generate random QR code for now
    var x = Math.floor((Math.random() * 99) + 1);
    document.getElementById("qrCode").innerHTML = ("<img src='https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + x + "'>");

    if (timerStyle == "TRight"){
        document.getElementById("countdown").style.right = "0";
        document.getElementById("countdown").style.top = "0";
        document.getElementById("qrCode").style.left = "0";
        document.getElementById("qrCode").style.top = "0";
    }
    else if (timerStyle == "BLeft"){
        document.getElementById("countdown").style.left = "0";
        document.getElementById("countdown").style.bottom = "0";
        document.getElementById("qrCode").style.right = "0";
        document.getElementById("qrCode").style.bottom = "0";
    }
    else if (timerStyle == "BRight"){
        document.getElementById("countdown").style.right = "0";
        document.getElementById("countdown").style.bottom = "0";
        document.getElementById("qrCode").style.left = "0";
        document.getElementById("qrCode").style.bottom = "0";
    }
    else if (timerStyle == "TLeft"){
        document.getElementById("countdown").style.left = "0";
        document.getElementById("countdown").style.top = "0";
        document.getElementById("qrCode").style.right = "0";
        document.getElementById("qrCode").style.top = "0";
    }

    //intercept the command callback from the player
    //POST to herokuapp for testing
    /* try {
        window['RevelDigital.Controller'] = {
            onCommand: function(name, arg) {
                document.getElementById("countdown").innerHTML = name + "-" + arg;
                axios.post("https://photo-booth.herokuapp.com/photo", {
                    "key": "7ef4a535-e988-4f71-ada8-522a5b5da812",
                    "photo": arg
                })
                .then((response) => console.log(response.data))
                .then((error) => console.log(error));
            }
        }
    } catch (error) {
        document.getElementById("countdown").innerHTML += error;
    } */

    window['RevelDigital.Controller'] = { 
        onCommand: function(name, arg) { 
            console.log(arg); 
            console.log(name); 
            document.getElementById("countdown").innerHTML += " control";
        } 
    }

    //listener to activate timer in future potential
    function startTimer(){
        console.log("Timer Started");
        return true;
    }

    if (startTimer()){
        var downloadTimer = setInterval(function(){
            //when timer hits 0
            if(timeRemain <= 0){
                clearInterval(downloadTimer);
                document.getElementById("countdown").innerHTML = "Cheese!";
                Client.sendCommand("takesnapshot", ""); // <-----
                document.getElementById("countdown").innerHTML = "Snap Taken";
                console.log("snapshot taken");
            } else {
                document.getElementById("countdown").innerHTML = timeRemain;
            }
            timeRemain -= 1;
        }, 1000);
    }

</script>]]></Content>
</Module>